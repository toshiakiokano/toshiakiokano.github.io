<!DOCTYPE html>
<html>
<head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <title>Ep</title>
    <meta content='noindex' name='robots'>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script>
</head>
<body>

<video id="player" controls autoplay playsinline></video>
<canvas id="canvas" width="300" height="100"></canvas>
<button id="capture">Capture</button>

<div id="msg"></div>
<canvas id="snapshot" width="300" height="100"></canvas>



<script>
    (function () {
        Tesseract
            .recognize("u.jpg", {
                lang: 'jpn'
            })
            .progress(function(p) {
                $("#msg").text('準備中' + p.status + ": " + (100 * p.progress).toFixed(1) + '%>');
            })
            .then(function(result) {
                $("#msg").text('準備完了');
            })
    }());



    var video = document.getElementById("player");
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    requestAnimationFrame(draw);

    function draw() {
        canvas.width = 300;
        canvas.height = 100;

        ctx.drawImage(video, 100, 300, 600, 200, 0, 0, 300, 100);
        imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        data = imgData.data;

        for(let i = 0; i < data.length; i += 4) {
            ave = (data[i + 0] + data[i + 1] + data[i + 2]) / 3;
            data[i + 0] =
                data[i + 1] =
                    data[i + 2] = (ave > 128 ? 255 : 0);
            data[i + 3] = 255;
        }

        ctx.putImageData(imgData, 0, 0);
        requestAnimationFrame(draw)
    }

    var snapshotCanvas = document.getElementById('snapshot');
    var captureButton = document.getElementById('capture');
    var handleSuccess = function(stream) {
        video.srcObject = stream;
    };
    var num = 1;


    captureButton.addEventListener('click', function () {
        var context = snapshot.getContext('2d');

        context.drawImage(video, 100, 300, 600, 200, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

        const url = snapshot.toDataURL('image/png');

        Tesseract
            .recognize(url, {
                lang: 'eng'
            })
            .progress(function(p) {
                $("#msg").text(p.status + ": " + p.progress);
            })
            .then(function(result) {
                console.log(result)
                $("#msg").text("Progress Complete")
                var elem = document.createElement('div');
                elem.innerHTML = "<div id=" + num + " style='width:300px; background-color:#EEEEEE'><img src=" + url + " /></div><br>"
                var parent = document.getElementById("results");
                parent.insertBefore(elem, parent.firstChild);
                var numdiv = document.getElementById(num);
                var msg = document.createElement('div');
                msg.innerHTML = result.text;
                numdiv.appendChild(msg);
                num += 1;
            });
    });
    var front = false;
    var constraints = {
        audio: false,
        video: {
            width: 1920,
            height: 1080,
            facingMode: (front ? "user" : "environment")
        }
    };
    navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess);
</script>
<div id="results" align="center"></div>
</body>
</html>
